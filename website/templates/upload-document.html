{% extends "base.html" %} {% block title %}Upload{% endblock %} {% block content
%}

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Document</title>
</head>
<body>
  <h1>Upload Document</h1>
  <form id="uploadForm">
    <label for="pdf_file">Select PDF file:</label><br />
    <input
      type="file"
      id="pdf_file"
      name="pdf_file"
      accept=".pdf"
      required
    /><br /><br />

    <label for="course">Course:</label><br />
    <input type="text" id="course" name="course" required /><br /><br />

    <label for="school">School:</label><br />
    <input type="text" id="school" name="school" required /><br /><br />

    <label for="upload_comment">Upload Comment:</label><br />
    <textarea
      id="upload_comment"
      name="upload_comment"
      rows="4"
      cols="50"
      required
    ></textarea
    ><br /><br />

    <label for="subject">Subject:</label><br />
    <input type="text" id="subject" name="subject" required /><br /><br />

    <label for="uid">User ID:</label><br />
    <input type="text" id="uid" name="uid" required /><br /><br />

    <label for="header">Header:</label><br />
    <input type="text" id="header" name="header" required /><br /><br />

    <label for="type_of_document">Type of Document:</label><br />
    <input
      type="text"
      id="type_of_document"
      name="type_of_document"
      required
    /><br /><br />

    <label for="tags">Tags:</label><br />
    <input type="text" id="tags" name="tags" required /><br /><br />

    <button type="button" id="submitUploadBtn">Submit Upload</button>
  </form>

  <script type="module">
    // Firebase configuration and initialization
    import firebaseConfig from "{{ url_for('static', filename='firebase-cfg.js') }}";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {
      getStorage,
      ref,
      uploadBytesResumable,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

    const app = initializeApp(firebaseConfig);

    // Add event listener to submit button
    document.getElementById("submitUploadBtn").addEventListener("click", () => {
      uploadDocument();
    });

    function uploadDocument() {
      var fileInput = document.getElementById("pdf_file");
      var file = fileInput.files[0];

      // Create a storage reference
      var storage = getStorage(app);
      var storageRef = ref(storage, "temp/" + file.name);

      // Upload file to Firebase Storage
      var uploadTask = uploadBytesResumable(storageRef, file);

      // Listen for state changes, errors, and completion of the upload.
      uploadTask.on(
        "state_changed",
        function (snapshot) {
          // Handle upload progress
          var progress =
            (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          console.log("Upload is " + progress + "% done");
        },
        function (error) {
          // Handle unsuccessful upload
          console.error("Error uploading file:", error);
        },
        function () {
          // Handle successful upload
          getDownloadURL(uploadTask.snapshot.ref).then(function (downloadURL) {
            console.log("File available at", downloadURL);
            // Once you have the downloadURL, you can add it to the form data and submit the form
            var formData = new FormData(document.getElementById("uploadForm"));
            formData.append("downloadURL", downloadURL); // Add downloadURL to form data

            // Now you can submit the form with all data, including the downloadURL
            submitForm(formData);
          });
        }
      );
    }

    function submitForm(formData) {
      // Submit the form with all data, including the downloadURL
      fetch("/upload_document", {
        method: "POST",
        body: formData,
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.text();
        })
        .then((data) => {
          console.log(data); // Handle success response
        })
        .catch((error) => {
          console.error("There was a problem with the fetch operation:", error);
        });
    }
  </script>
</body>
{% endblock %}

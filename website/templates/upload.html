{% extends "base.html" %} {% block title %}Upload{% endblock %} {% block content
%}

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Document</title>
</head>
<body>
  <h1>Upload Document</h1>
  <form id="uploadForm">
    <label for="pdf_file">Select PDF file:</label><br />
    <input
      type="file"
      id="pdf_file"
      name="pdf_file"
      accept=".pdf"
      onchange="previewPDF()"
      required
    /><br /><br />

    <label for="school">School:</label><br />
    <input type="text" id="school" name="school" required /><br /><br />

    <label for="subject">Subject:</label><br />
    <select id="subject" name="subject" required>
      <option value="" disabled selected>Select Subject</option>
      <option value="Economics">Economics</option>
      <option value="Programming">Programming</option>
      <option value="Mathematics">Mathematics</option>
      <option value="Other">Other</option></select
    ><br /><br />

    <label for="course">Course:</label><br />
    <input type="text" id="course" name="course" required /><br /><br />

    <label for="type_of_document">Type of Document:</label><br />
    <select id="type_of_document" name="type_of_document" required>
      <option value="" disabled selected>Select Type</option>
      <option value="Assignments">Assignment</option>
      <option value="Exams">Exam</option>
      <option value="Course Materials">Lecture Material</option>
      <option value="Lecture Notes">Lecture Notes</option>
      <option value="Other">Other</option></select
    ><br /><br />

    <label for="header">Header:</label><br />
    <input type="text" id="header" name="header" required /><br /><br />

    <label for="upload_comment">Upload Comment:</label><br />
    <textarea
      id="upload_comment"
      name="upload_comment"
      rows="4"
      cols="50"
      required
    ></textarea
    ><br /><br />

    <label for="tags">Tags (Optional):</label><br />
    <input type="text" id="tags" name="tags" /><br /><br />

    <div id="previewContainer" class="center-align">
      <iframe
        id="pdfPreview"
        style="display: none; width: 100%; height: 500px"
        frameborder="0"
      ></iframe>
    </div>

    <button type="button" id="submitUploadBtn">Submit Upload</button>
  </form>

  <script>
    function previewPDF() {
      var file = document.getElementById("pdf_file").files[0];
      var pdfPreview = document.getElementById("pdfPreview");

      // Hide the preview initially
      pdfPreview.style.display = "none";

      if (file) {
        var blobUrl = URL.createObjectURL(file);

        if (file.type === "application/pdf") {
          // Handle PDF files
          pdfPreview.src = blobUrl;
          pdfPreview.style.display = "block";
        }
      }
    }
  </script>

  <script type="module">
    // Firebase configuration and initialization
    import firebaseConfig from "{{ url_for('static', filename='firebase-cfg.js') }}";
    import {
      getStorage,
      ref,
      uploadBytesResumable,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { app, auth, userExists } from "../static/index.js";

    // Add event listener to submit button

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const uid = user.uid;

        userExists(uid).then((exists) => {
          if (exists) {
            document
              .getElementById("submitUploadBtn")
              .addEventListener("click", () => {
                uploadDocument(uid);
              });
          } else {
            window.location.href = "/create_profile";
          }
        });
      } else {
        window.location.href = "/login";
      }
    });

    function uploadDocument(uid) {
      var fileInput = document.getElementById("pdf_file");
      var file = fileInput.files[0];

      // Create a storage reference
      var storage = getStorage(app);
      var storageRef = ref(storage, "temp/" + file.name);
      var storageRef = ref(storage, `temp/${uid}/${file.name}`);

      // Upload file to Firebase Storage
      var uploadTask = uploadBytesResumable(storageRef, file);

      // Listen for state changes, errors, and completion of the upload.
      uploadTask.on(
        "state_changed",
        function (snapshot) {
          // Handle upload progress
          var progress =
            (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          console.log("Upload is " + progress + "% done");
        },
        function (error) {
          // Handle unsuccessful upload
          console.error("Error uploading file:", error);
        },
        function () {
          // Handle successful upload
          getDownloadURL(uploadTask.snapshot.ref).then(function (downloadURL) {
            console.log("File available at", downloadURL);
            // Once you have the downloadURL, you can add it to the form data and submit the form
            var formData = new FormData(document.getElementById("uploadForm"));
            formData.append("downloadURL", downloadURL); // Add downloadURL to form data
            formData.append("uid", uid); // Add uid to form data

            // Now you can submit the form with all data, including the downloadURL
            submitForm(formData);
          });
        }
      );
    }

    function submitForm(formData) {
      // Submit the form with all data, including the downloadURL
      fetch("/upload_document", {
        method: "POST",
        body: formData,
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.text();
        })
        .then((data) => {
          console.log(data); // Handle success response
        })
        .catch((error) => {
          console.error("There was a problem with the fetch operation:", error);
        });
    }
  </script>
</body>
{% endblock %}

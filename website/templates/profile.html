{% extends "base.html" %}
{% block title %}Profile{% endblock %}
{% block content %}
<style>
    /* Add your custom CSS styles here */
    .profile-card {
        max-width: 500px;
        margin: 50px auto;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        background-color: #fff;
    }
    .profile-card h3 {
        margin-bottom: 15px;
        color: #333;
    }
    .profile-card p {
        margin-bottom: 10px;
        color: #666;
    }
    .document-list {
        margin-top: 20px;
    }
    .document-item {
        margin-bottom: 10px;
    }
    .document-link {
        color: #007bff;
        text-decoration: none;
    }
    .no-documents-message {
        font-style: italic;
        color: #888;
    }
    .upload-link {
        color: #007bff;
        text-decoration: none;
    }
</style>

<div class="profile-card" id="profileContainer"></div>

<script type="module">
    import firebaseConfig from "{{ url_for('static', filename='firebase-cfg.js') }}";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getDatabase, ref, child, get } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            const dbRef = ref(getDatabase());
            const uid = user.uid;
            
            get(child(dbRef, `Users/${user.uid}/username`)).then((snapshot) => {
                let username = '';
                if (snapshot.exists()) {
                    username = snapshot.val().toString();
                    // If username exists, fetch creation date
                    get(child(dbRef, `Users/${user.uid}/creation_date`)).then((dateSnapshot) => {
                        let creationDate = '';
                        if (dateSnapshot.exists()) {
                            creationDate = dateSnapshot.val().toString();
                        } else {
                            creationDate = 'Unknown';
                        }
                        // Display profile including username and creation date
                        displayProfile(user.displayName, username, user.email, creationDate);
                    }).catch((error) => {
                        console.error(error);
                    });
                } else {
                    // If username doesn't exist, display form to add username
                    displayUsernameForm();
                }
            }).catch((error) => {
                console.error(error);
            });
        } else {
            // Provide login prompt
            const loginPrompt = `
                <div class="login-prompt">
                    <p>Please <a href="/login" class="login-link">log in</a> to view your profile.</p>
                </div>
            `;
            document.getElementById("profileContainer").innerHTML = loginPrompt;
        }
    });

    function displayProfile(displayName, username, email, creationDate) {
        let profileView = `
            <h3>Welcome, ${displayName}!</h3>
            <p>Username: ${username}</p>
            <p>Email: ${email}</p>
            <p>Member since: ${creationDate}</p>
            <!-- Add more profile information here -->
        `;
        document.getElementById("profileContainer").innerHTML = profileView;
    }

    function displayUsernameForm() {
        // Add code here to display the form for adding a username
    }
</script>
{% endblock %}
